name: Deploy SquareUp

on:
  push:
    branches:
      - squareup-dev
      - squareup-almost
      - squareup-live

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Environment Variables
        id: env_setup
        run: |
          if [[ "${{ github.ref_name }}" == "squareup-live" ]]; then
            echo "SERVICE=squareup-backend" >> $GITHUB_OUTPUT
            echo "DB_SECRET=PROD_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=production" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=production" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=1" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "squareup-almost" ]]; then
            echo "SERVICE=squareup-backend-staging" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=staging" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=staging" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=1" >> $GITHUB_OUTPUT
          else
            echo "SERVICE=squareup-backend-dev" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=development" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=development" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=0" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Run Database Migrations
        working-directory: ./backend
        run: |
          # Use the same Python environment/deps as the app
          pip install alembic psycopg2-binary sqlalchemy sqlmodel pydantic-settings asyncpg
          
          # Fetch the secret dynamically based on branch
          DB_URL_VAL="${{ secrets[steps.env_setup.outputs.DB_SECRET] }}"
          
          # Execute migration
          DATABASE_URL="$DB_URL_VAL" ENVIRONMENT="${{ steps.env_setup.outputs.ENV_NAME }}" alembic upgrade head

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      - name: Deploy Backend to Cloud Run
        working-directory: ./backend
        run: |
          # Dynamic URLs based on environment
          if [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "production" ]]; then
            export BASE_URL="https://app.joinsquareup.com"
          elif [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "staging" ]]; then
            export BASE_URL="https://almost.joinsquareup.com"
          else
            export BASE_URL="https://unclutr-monorep.web.app" # Default for dev branch
          fi

          # Use Python to safely generate the env file without shell expansion issues
          python3 -c "
          import os, json
          env_vars = {
              'DATABASE_URL': os.environ.get('DATABASE_URL_SECRET'),
              'ENVIRONMENT': os.environ.get('ENVIRONMENT_NAME'),
              'BACKEND_URL': os.environ.get('BASE_URL'),
              'FRONTEND_URL': os.environ.get('BASE_URL'),
              'GOOGLE_CLIENT_ID': os.environ.get('GOOGLE_CLIENT_ID_SECRET'),
              'GOOGLE_CLIENT_SECRET': os.environ.get('GOOGLE_CLIENT_SECRET_SECRET'),
              'GOOGLE_REDIRECT_URI': f\"{os.environ.get('BASE_URL')}/api/v1/intelligence/calendar/google/callback\",
              'SHOPIFY_ENCRYPTION_KEY': os.environ.get('SHOPIFY_ENCRYPTION_KEY_SECRET'),
              'SHOPIFY_API_KEY': os.environ.get('SHOPIFY_API_KEY_SECRET'),
              'SHOPIFY_API_SECRET': os.environ.get('SHOPIFY_API_SECRET_SECRET'),
              'GEMINI_API_KEY': os.environ.get('GEMINI_API_KEY_SECRET'),
              'FIREBASE_CREDENTIALS_JSON': os.environ.get('FIREBASE_CREDENTIALS_JSON_SECRET')
          }
          # Remove any None values
          env_vars = {k: v for k, v in env_vars.items() if v is not None}
          with open('env.json', 'w') as f:
              json.dump(env_vars, f)
          "
        env:
          DATABASE_URL_SECRET: ${{ secrets[steps.env_setup.outputs.DB_SECRET] }}
          ENVIRONMENT_NAME: ${{ steps.env_setup.outputs.ENV_NAME }}
          GOOGLE_CLIENT_ID_SECRET: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          SHOPIFY_ENCRYPTION_KEY_SECRET: ${{ secrets.SHOPIFY_ENCRYPTION_KEY }}
          SHOPIFY_API_KEY_SECRET: ${{ secrets.SHOPIFY_API_KEY }}
          SHOPIFY_API_SECRET_SECRET: ${{ secrets.SHOPIFY_API_SECRET }}
          GEMINI_API_KEY_SECRET: ${{ secrets.GEMINI_API_KEY }}
          FIREBASE_CREDENTIALS_JSON_SECRET: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}

      - name: Update Cloud Run Service
        working-directory: ./backend
        run: |
          gcloud run deploy ${{ steps.env_setup.outputs.SERVICE }} \
            --source . \
            --region asia-south1 \
            --platform managed \
            --allow-unauthenticated \
            --session-affinity \
            --use-http2 \
            --memory 2Gi \
            --cpu 2 \
            --timeout 600 \
            --min-instances ${{ steps.env_setup.outputs.MIN_INSTANCES }} \
            --max-instances 10 \
            --cpu-boost \
            --cpu-throttling \
            --env-vars-file env.json

      - name: Deploy Frontend to Firebase
        run: |
          firebase experiments:enable webframeworks
          firebase deploy --only hosting:${{ steps.env_setup.outputs.FIREBASE_TARGET }} --token ${{ secrets.FIREBASE_TOKEN }}
