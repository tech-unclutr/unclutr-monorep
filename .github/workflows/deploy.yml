name: Deploy SquareUp

on:
  push:
    branches:
      - squareup-dev
      - squareup-almost
      - squareup-live

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Environment Variables
        id: env_setup
        run: |
          if [[ "${{ github.ref_name }}" == "squareup-live" ]]; then
            echo "SERVICE=squareup-backend" >> $GITHUB_OUTPUT
            echo "DB_SECRET=PROD_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=production" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=production" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=1" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "squareup-almost" ]]; then
            echo "SERVICE=squareup-backend-staging" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=staging" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=staging" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=1" >> $GITHUB_OUTPUT
          else
            echo "SERVICE=squareup-backend-dev" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=development" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=development" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=0" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Cloud SQL Auth Proxy
        run: |
          # Download the Cloud SQL Auth Proxy
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.21.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 unclutr-monorep:asia-south1:unclutr-db-india &
          
          # Wait for proxy to be ready
          for i in $(seq 1 30); do
            if nc -z 127.0.0.1 5432 2>/dev/null; then
              echo "Cloud SQL Proxy is ready"
              break
            fi
            echo "Waiting for Cloud SQL Proxy... ($i/30)"
            sleep 1
          done

      - name: Run Database Migrations
        working-directory: ./backend
        run: |
          # Use the same Python environment/deps as the app
          pip install alembic psycopg2-binary sqlalchemy sqlmodel pydantic-settings asyncpg
          
          # Rewrite the host to go through the Cloud SQL Auth Proxy on localhost
          export DATABASE_URL=$(python3 -c "
          import os
          from urllib.parse import urlparse, urlunparse
          url = urlparse(os.environ['DB_URL_SECRET'])
          user_info = url.username or ''
          if url.password:
              user_info += ':' + url.password
          new_netloc = (user_info + '@' if user_info else '') + '127.0.0.1:5432'
          print(urlunparse(url._replace(netloc=new_netloc)))
          ")
          
          # Execute migration
          ENVIRONMENT="${{ steps.env_setup.outputs.ENV_NAME }}" alembic upgrade head
        env:
          DB_URL_SECRET: ${{ secrets[steps.env_setup.outputs.DB_SECRET] }}

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      - name: Deploy Backend to Cloud Run
        working-directory: ./backend
        run: |
          # Dynamic URLs based on environment
          if [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "production" ]]; then
            export BASE_URL="https://app.joinsquareup.com"
          elif [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "staging" ]]; then
            export BASE_URL="https://almost.joinsquareup.com"
          else
            export BASE_URL="https://unclutr-monorep.web.app" # Default for dev branch
          fi

          # Use Python to safely generate the env file without shell expansion issues
          python3 -c "
          import os, json
          from urllib.parse import urlparse, urlunparse

          # Get base secret
          db_secret = os.environ.get('DATABASE_URL_SECRET')
          
          # Construct Unix Socket URL for Cloud Run
          # Format: postgresql+asyncpg://user:pass@/dbname?host=/cloudsql/INSTANCE_CONNECTION_NAME
          try:
              url = urlparse(db_secret)
              
              # Cloud SQL Instance Connection Name
              instance_connection_name = 'unclutr-monorep:asia-south1:unclutr-db-india'
              
              # Safely extract user:pass@ from netloc to preserve encoding
              # netloc is user:pass@host:port
              # We want to keep user:pass@ and remove host:port
              # modifying to add 'localhost' to ensure sqlalchemy parses it correctly
              if '@' in url.netloc:
                  user_pass = url.netloc.rsplit('@', 1)[0]
                  new_netloc = user_pass + '@localhost'
              else:
                  new_netloc = 'localhost' # Fallback content
              
              # Query params for Unix socket
              # host query param tells asyncpg to use the unix socket
              new_query = f'host=/cloudsql/{instance_connection_name}'
              
              # Reconstruct URL
              # Scheme: postgresql+asyncpg (asyncpg requires this scheme in SQLAlchemy)
              # Netloc: user:pass@ (empty host)
              # Path: /dbname
              # Query: host=/cloudsql/...
              unix_socket_url = urlunparse((
                  'postgresql+asyncpg',
                  new_netloc,
                  url.path,
                  '',
                  new_query,
                  ''
              ))
          except Exception as e:
              print(f'Error parsing DB URL: {e}')
              unix_socket_url = db_secret # Fallback

          env_vars = {
              'DATABASE_URL': unix_socket_url,
              'ENVIRONMENT': os.environ.get('ENVIRONMENT_NAME'),
              'BACKEND_URL': os.environ.get('BASE_URL'),
              'FRONTEND_URL': os.environ.get('BASE_URL'),
              'GOOGLE_CLIENT_ID': os.environ.get('GOOGLE_CLIENT_ID_SECRET'),
              'GOOGLE_CLIENT_SECRET': os.environ.get('GOOGLE_CLIENT_SECRET_SECRET'),
              'GOOGLE_REDIRECT_URI': f\"{os.environ.get('BASE_URL')}/api/v1/intelligence/calendar/google/callback\",
              'SHOPIFY_ENCRYPTION_KEY': os.environ.get('SHOPIFY_ENCRYPTION_KEY_SECRET'),
              'SHOPIFY_API_KEY': os.environ.get('SHOPIFY_API_KEY_SECRET'),
              'SHOPIFY_API_SECRET': os.environ.get('SHOPIFY_API_SECRET_SECRET'),
              'GEMINI_API_KEY': os.environ.get('GEMINI_API_KEY_SECRET'),
              'FIREBASE_CREDENTIALS_JSON': os.environ.get('FIREBASE_CREDENTIALS_JSON_SECRET')
          }
          # Remove any None values
          env_vars = {k: v for k, v in env_vars.items() if v is not None}
          with open('env.json', 'w') as f:
              json.dump(env_vars, f)
          "
        env:
          DATABASE_URL_SECRET: ${{ secrets[steps.env_setup.outputs.DB_SECRET] }}
          ENVIRONMENT_NAME: ${{ steps.env_setup.outputs.ENV_NAME }}
          GOOGLE_CLIENT_ID_SECRET: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          SHOPIFY_ENCRYPTION_KEY_SECRET: ${{ secrets.SHOPIFY_ENCRYPTION_KEY }}
          SHOPIFY_API_KEY_SECRET: ${{ secrets.SHOPIFY_API_KEY }}
          SHOPIFY_API_SECRET_SECRET: ${{ secrets.SHOPIFY_API_SECRET }}
          GEMINI_API_KEY_SECRET: ${{ secrets.GEMINI_API_KEY }}
          FIREBASE_CREDENTIALS_JSON_SECRET: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}

      - name: Update Cloud Run Service
        working-directory: ./backend
        run: |
          gcloud run deploy ${{ steps.env_setup.outputs.SERVICE }} \
            --source . \
            --region asia-south1 \
            --platform managed \
            --allow-unauthenticated \
            --session-affinity \
            --use-http2 \
            --memory 2Gi \
            --cpu 2 \
            --timeout 600 \
            --min-instances ${{ steps.env_setup.outputs.MIN_INSTANCES }} \
            --max-instances 10 \
            --cpu-boost \
            --cpu-throttling \
            --add-cloudsql-instances unclutr-monorep:asia-south1:unclutr-db-india \
            --env-vars-file env.json

      - name: Deploy Frontend to Firebase
        run: |
          firebase experiments:enable webframeworks
          firebase deploy --only hosting:${{ steps.env_setup.outputs.FIREBASE_TARGET }} --force --token ${{ secrets.FIREBASE_TOKEN }}
