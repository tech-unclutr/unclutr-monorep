name: Deploy SquareUp

on:
  push:
    branches:
      - squareup-dev
      - squareup-almost
      - squareup-live

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Environment Variables
        id: env_setup
        run: |
          if [[ "${{ github.ref_name }}" == "squareup-live" ]]; then
            echo "SERVICE=squareup-backend" >> $GITHUB_OUTPUT
            echo "DB_SECRET=PROD_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=production" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=production" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=1" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "squareup-almost" ]]; then
            echo "SERVICE=squareup-backend-staging" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=staging" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=staging" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=1" >> $GITHUB_OUTPUT
          else
            echo "SERVICE=squareup-backend-dev" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=development" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=development" >> $GITHUB_OUTPUT
            echo "MIN_INSTANCES=0" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Start Cloud SQL Auth Proxy
        run: |
          # Download the Cloud SQL Auth Proxy
          curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.21.0/cloud-sql-proxy.linux.amd64
          chmod +x cloud-sql-proxy
          
          # Start proxy in background
          ./cloud-sql-proxy --port 5432 unclutr-monorep:asia-south1:unclutr-db-india &
          
          # Wait for proxy to be ready
          for i in $(seq 1 30); do
            if nc -z 127.0.0.1 5432 2>/dev/null; then
              echo "Cloud SQL Proxy is ready"
              break
            fi
            echo "Waiting for Cloud SQL Proxy... ($i/30)"
            sleep 1
          done

      - name: Run Database Migrations
        working-directory: ./backend
        run: |
          # Use the same Python environment/deps as the app
          pip install alembic psycopg2-binary sqlalchemy sqlmodel pydantic-settings asyncpg
          
          # Rewrite the host to go through the Cloud SQL Auth Proxy on localhost
          export DATABASE_URL=$(python3 -c "
          import os
          from urllib.parse import urlparse, urlunparse
          url = urlparse(os.environ['DB_URL_SECRET'])
          user_info = url.username or ''
          if url.password:
              user_info += ':' + url.password
          new_netloc = (user_info + '@' if user_info else '') + '127.0.0.1:5432'
          print(urlunparse(url._replace(netloc=new_netloc)))
          ")
          
          # Execute migration
          ENVIRONMENT="${{ steps.env_setup.outputs.ENV_NAME }}" alembic upgrade head
        env:
          DB_URL_SECRET: ${{ secrets[steps.env_setup.outputs.DB_SECRET] }}

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      - name: Deploy Backend to Cloud Run
        working-directory: ./backend
        run: |
          # Dynamic URLs based on environment
          if [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "production" ]]; then
            export BASE_URL="https://app.joinsquareup.com"
          elif [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "staging" ]]; then
            export BASE_URL="https://almost.joinsquareup.com"
          else
            export BASE_URL="https://unclutr-monorep.web.app" # Default for dev branch
          fi

          # Use Python to safely generate the env file without shell expansion issues
          # Run the robust python script to generate env.json
          python3 scripts/generate_deploy_env.py
        env:
          DATABASE_URL_SECRET: ${{ secrets[steps.env_setup.outputs.DB_SECRET] }}
          ENVIRONMENT_NAME: ${{ steps.env_setup.outputs.ENV_NAME }}
          GOOGLE_CLIENT_ID_SECRET: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          SHOPIFY_ENCRYPTION_KEY_SECRET: ${{ secrets.SHOPIFY_ENCRYPTION_KEY }}
          SHOPIFY_API_KEY_SECRET: ${{ secrets.SHOPIFY_API_KEY }}
          SHOPIFY_API_SECRET_SECRET: ${{ secrets.SHOPIFY_API_SECRET }}
          GEMINI_API_KEY_SECRET: ${{ secrets.GEMINI_API_KEY }}
          FIREBASE_CREDENTIALS_JSON_SECRET: ${{ secrets.FIREBASE_CREDENTIALS_JSON }}

      - name: Update Cloud Run Service
        working-directory: ./backend
        run: |
          gcloud run deploy ${{ steps.env_setup.outputs.SERVICE }} \
            --source . \
            --region asia-south1 \
            --platform managed \
            --allow-unauthenticated \
            --session-affinity \
            --no-use-http2 \
            --memory 2Gi \
            --cpu 2 \
            --timeout 600 \
            --min-instances ${{ steps.env_setup.outputs.MIN_INSTANCES }} \
            --max-instances 10 \
            --cpu-boost \
            --cpu-throttling \
            --add-cloudsql-instances unclutr-monorep:asia-south1:unclutr-db-india \
            --env-vars-file env.json

      - name: Deploy Frontend to Firebase
        run: |
          firebase experiments:enable webframeworks
          firebase deploy --only hosting:${{ steps.env_setup.outputs.FIREBASE_TARGET }} --force --token ${{ secrets.FIREBASE_TOKEN }}

      - name: Ensure Frontend Public Access (Staging)
        if: steps.env_setup.outputs.ENV_NAME == 'staging'
        run: |
          # The Firebase-managed Cloud Run service for staging is seemingly named 'ssrsquareupstaging'
          # We need to explicitly allow unauthenticated invocations as it defaults to private.
          echo "Run: Granting public access to ssrsquareupstaging..."
          gcloud run services add-iam-policy-binding ssrsquareupstaging \
            --region asia-south1 \
            --member=allUsers \
            --role=roles/run.invoker
