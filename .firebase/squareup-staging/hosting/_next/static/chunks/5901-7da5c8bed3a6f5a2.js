"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5901],{35901:(e,t,o)=>{o.d(t,{A:()=>d,AuthProvider:()=>u});var n=o(95155),r=o(12115),a=o(5877),i=o(89664),c=o(5151),l=o(76046);let s=(0,r.createContext)(void 0);function u(e){let{children:t}=e,[o,u]=(0,r.useState)(null),[d,g]=(0,r.useState)(null),[h,m]=(0,r.useState)(null),[p,y]=(0,r.useState)(null),[w,f]=(0,r.useState)(null),[v,S]=(0,r.useState)(!0),_=(0,r.useRef)(!0),I=e=>{S(e),_.current=e},[b,k]=(0,r.useState)(!1),[P,E]=(0,r.useState)(!1),A=(0,l.useRouter)(),D=(0,r.useRef)(!1),G=(0,r.useRef)(null);(0,r.useEffect)(()=>{if(D.current)return;D.current=!0;let e=!0,t=(async()=>{console.log("DEBUG: AuthProvider [Init] Starting setup...");let t=performance.now();(0,a.oM)(i.auth,a.F0).catch(e=>{console.error("DEBUG: AuthProvider [Init] Persistence error:",e)}),console.log("DEBUG: AuthProvider [Init] Attaching onAuthStateChanged observer...");let o=(0,a.hg)(i.auth,async o=>{if(!e)return;let n=performance.now();if(console.log("DEBUG: AuthProvider [State] Update triggered at ".concat(Math.round(n-t),"ms. User:"),(null==o?void 0:o.email)||"none"),u(o),o){if(G.current===o.uid){console.log("DEBUG: AuthProvider [Sync] Sync already in progress, skipping.");return}G.current=o.uid;let r="unclutr_last_sync_".concat(o.uid),a=sessionStorage.getItem(r),i=Date.now();if(a&&i-parseInt(a)<2e3){console.log("DEBUG: AuthProvider [Sync] Debounced (HMR protection). Skipping."),k(!1),e&&_.current&&(console.log("DEBUG: AuthProvider [Init] Clearing loading (Debounced Sync) at ".concat(Math.round(performance.now()-t),"ms")),I(!1));return}sessionStorage.setItem(r,i.toString()),console.log("DEBUG: AuthProvider [Sync] Starting background sync for",o.email),k(!0);try{let t=await (0,c.KF)(o),r=performance.now();console.log("DEBUG: AuthProvider [Sync] Completed in ".concat(Math.round(r-n),"ms")),console.log("DEBUG: AuthProvider [Sync] Response Data:",JSON.stringify(t,null,2)),console.log("DEBUG: AuthProvider [Sync] current_company_id:",t.current_company_id);let a=t.current_company_id||t.currentCompanyId;a?localStorage.setItem("unclutr_company_id",a):localStorage.removeItem("unclutr_company_id"),e&&(m(t.onboarding_completed),y(a),f(t.role||null),g(t))}catch(t){console.error("DEBUG: AuthProvider [Sync] Background Error:",t),e&&m(null!=h&&h)}finally{G.current=null,k(!1),e&&_.current&&(console.log("DEBUG: AuthProvider [Init] Clearing loading state after sync."),I(!1))}}else console.log("DEBUG: AuthProvider [Sync] No user, clearing context."),m(null),y(null),f(null),g(null),localStorage.removeItem("unclutr_company_id"),G.current=null,e&&_.current&&(console.log("DEBUG: AuthProvider [Init] Clearing loading (No Session) at ".concat(Math.round(performance.now()-t),"ms")),I(!1))});(async()=>{console.log("DEBUG: AuthProvider [Init] Checking Redirect Result...");let t=performance.now(),o=(0,c.fH)(),n=new Promise((e,t)=>setTimeout(()=>t(Error("Redirect Timeout")),5e3));try{let r=await Promise.race([o,n]),a=performance.now();console.log("DEBUG: AuthProvider [Init] Redirect check finished in ".concat(Math.round(a-t),"ms")),(null==r?void 0:r.user)&&e&&(console.log("DEBUG: AuthProvider [Init] Redirect Success:",r.user.email),u(r.user))}catch(e){console.warn("DEBUG: AuthProvider [Init] Redirect handled (or timed out):",e)}})();let n=setTimeout(()=>{e&&_.current&&(console.warn("DEBUG: AuthProvider [Init] Safety timeout clearing loading (15s). Context may be inconsistent."),I(!1))},15e3);return()=>{o(),clearTimeout(n)}})();return()=>{e=!1,t.then(e=>e&&e())}},[]);let U=async()=>{if(o){k(!0);try{let e=await (0,c.KF)(o),t=e.current_company_id||e.currentCompanyId;t?localStorage.setItem("unclutr_company_id",t):localStorage.removeItem("unclutr_company_id"),m(e.onboarding_completed),y(t),f(e.role||null),g(e)}catch(e){console.error("DEBUG: AuthProvider [Refresh] Error:",e)}finally{k(!1)}}},B=async()=>{try{await (0,c.ri)(),Object.keys(localStorage).forEach(e=>{(e.startsWith("csv_upload_")||e.startsWith("campaign_composer_"))&&localStorage.removeItem(e)}),Object.keys(sessionStorage).forEach(e=>{(e.startsWith("csv_upload_")||e.startsWith("campaign_composer_"))&&sessionStorage.removeItem(e)}),sessionStorage.removeItem("unclutr_skip_onboarding"),u(null),m(null),y(null),f(null),g(null),localStorage.removeItem("unclutr_company_id"),A.push("/login")}catch(e){console.error("DEBUG: Logout failed:",e)}};return(0,n.jsx)(s.Provider,{value:{user:o,dbUser:d,loading:v,isAuthenticated:!!o,onboardingCompleted:h,companyId:p,role:w,isSyncing:b,hasSkippedOnboarding:P,logout:B,refreshAuth:U,skipOnboardingSession:()=>{E(!0),sessionStorage.setItem("unclutr_skip_onboarding","true")}},children:t})}function d(){let e=(0,r.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},53567:(e,t,o)=>{o.d(t,{HK:()=>c,Oz:()=>d,g6:()=>u,st:()=>i,sx:()=>l,v:()=>s});var n=o(12115),r=o(55321),a=o(89664);let i=()=>{(0,n.useEffect)(()=>{(0,r.TT)().then(e=>{if(e)try{let e=(0,r.P5)(a.app);(0,r.$s)(e,"page_view",{page_path:window.location.pathname,page_title:document.title})}catch(e){}})},[])},c=()=>{(0,n.useEffect)(()=>{let e=e=>{let t=e.target.closest("button, a, [data-track]");if(t){let e=t.innerText||t.getAttribute("aria-label")||"";e=e.slice(0,50).trim();let o=t.id||t.getAttribute("data-id")||"unknown",n=t.tagName.toLowerCase();if(t.hasAttribute("data-no-track"))return;l("user_interaction",{event_category:"ui_interaction",event_action:"click",event_label:e,element_type:n,element_id:o,page_path:window.location.pathname})}};return window.addEventListener("click",e),()=>window.removeEventListener("click",e)},[])},l=(e,t)=>{(0,r.TT)().then(o=>{if(o)try{let o=(0,r.P5)(a.app);(0,r.$s)(o,e,t)}catch(e){}})};function s(e,t){let o={event:e,timestamp:new Date().toISOString(),...t};l(e,t);try{let e=JSON.parse(localStorage.getItem("onboarding_events")||"[]");e.push(o),e.length>100&&e.shift(),localStorage.setItem("onboarding_events",JSON.stringify(e))}catch(e){}}function u(e,t){l("auth_".concat(e),{...t,timestamp:new Date().toISOString()})}function d(e,t){var o;l("error_occurred",{error_message:e.message,error_stack:null===(o=e.stack)||void 0===o?void 0:o.slice(0,500),...t,timestamp:new Date().toISOString()})}},5151:(e,t,o)=>{o.d(t,{Rq:()=>s,fH:()=>g,ri:()=>m,f:()=>h,G6:()=>d,KF:()=>u});var n=o(5877),r=o(89664);window.fetch;let a=(e,t)=>{},i=(e,t)=>{console.error("[Firebase Error] ".concat(e,":"),t)};var c=o(53567),l=o(2818);let s=e=>{switch((null==e?void 0:e.code)||""){case"auth/popup-closed-by-user":return"The sign-in window was closed before finishing. Give it another shot!";case"auth/network-request-failed":return"A network hiccup occurred. Please check your connection and try again.";case"auth/invalid-email":return"That doesn't look like a valid email. Double-check for typos?";case"auth/user-disabled":return"This account has been disabled. Please reach out to our support team.";case"auth/too-many-requests":return"System's a bit busy. Please wait a moment before trying again.";case"auth/expired-action-code":return"This login link has expired. Let's send you a fresh one.";case"auth/invalid-action-code":return"This login link isn't valid. Please request a new one below.";case"auth/popup-blocked":return"The login popup was blocked by your browser. Please allow popups for Unclutr.";case"auth/operation-not-allowed":return"This sign-in method isn't enabled yet. We're looking into it.";default:var t;return(null==e?void 0:null===(t=e.message)||void 0===t?void 0:t.includes("network"))?"Connection lost. Please try again.":"Something went wrong on our end. Please try again in a moment."}},u=async e=>{var t;let o="[Sync:".concat(null===(t=e.email)||void 0===t?void 0:t.split("@")[0],"]");a("".concat(o," Starting sync..."));try{let t=await e.getIdToken(),n=l.env.NEXT_PUBLIC_API_URL||"";n.endsWith("/")&&(n=n.slice(0,-1));let r=n.endsWith("/api/v1")?"".concat(n,"/auth/sync"):"".concat(n,"/api/v1/auth/sync"),i=new AbortController,c=setTimeout(()=>i.abort(),8e3),s=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(t)},signal:i.signal});if(clearTimeout(c),!s.ok)throw Error("Sync failed: ".concat(s.status));let u=await s.json();return a("".concat(o," Sync Success"),u),u}catch(t){return i("".concat(o," Sync Error"),t),console.warn("".concat(o," Backend unavailable/Sync failed. Returning partial session.")),{onboarding_completed:!1,current_company_id:null,user_id:e.uid,email:e.email}}},d=async()=>{if("localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname){a("signInWithGoogle - Using Popup (Localhost Optimization)");try{let e=new n.HF;e.setCustomParameters({prompt:"select_account"});let t=await (0,n.df)(r.auth,e);return t.user&&((0,c.g6)("login",{method:"google",mode:"popup"}),window.location.assign("/dashboard")),t}catch(e){throw i("signInWithGoogle (Popup)",e),(0,c.g6)("login_failed",{method:"google",mode:"popup",error:e.message}),(0,c.Oz)(e,{context:"google_signin_popup"}),e}}a("signInWithGoogle - Starting (Redirect)");try{let e=new n.HF;e.setCustomParameters({prompt:"select_account"}),await (0,n.$2)(r.auth,e)}catch(e){throw i("signInWithGoogle",e),e}},g=async()=>{try{let e=await (0,n.Q4)(r.auth);if(null==e?void 0:e.user)return(0,c.g6)("login",{method:"google",mode:"redirect"}),e;return null}catch(e){throw i("handleAuthRedirect",e),e}},h=async e=>{a("sendEmailSignInLink",{email:e});try{let t={url:"".concat(window.location.origin,"/auth/verify"),handleCodeInApp:!0};await (0,n.MN)(r.auth,e,t),window.localStorage.setItem("emailForSignIn",e),a("sendEmailSignInLink - Success",{email:e})}catch(e){throw i("sendEmailSignInLink",e),e}},m=async()=>{a("logout - Starting");try{await (0,n.CI)(r.auth),window.localStorage.removeItem("emailForSignIn"),(0,c.g6)("logout"),a("logout - Success")}catch(e){throw i("logout",e),(0,c.Oz)(e,{context:"logout"}),e}}},89664:(e,t,o)=>{o.r(t),o.d(t,{app:()=>u,auth:()=>d,initRemoteConfig:()=>h,storage:()=>g});var n=o(49904),r=o(5877),a=o(55321),i=o(66919),c=o(65684),l=o(6802);let s={apiKey:"AIzaSyBV4-x1knQDLxrUw0A5gJCqpDkGYWtxiQ0",authDomain:(()=>{let e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?"unclutr-monorep.firebaseapp.com":e})(),projectId:"unclutr-monorep",storageBucket:"unclutr-monorep.firebasestorage.app",messagingSenderId:"527397315020",appId:"1:527397315020:web:fb9ccca0b949751fa5bd69",measurementId:"G-Y6S6ESHRFN"};console.log("Firebase Config Loaded (Hardcoded Backup)"),console.log("[Firebase] Using authDomain: ".concat(s.authDomain));let u=0===(0,n.Dk)().length?(0,n.Wp)(s):(0,n.Dk)()[0],d=(0,r.xI)(u);(0,r.oM)(d,r.F0).catch(console.error);let g=(0,l.c7)(u);(0,a.TT)().then(e=>{if(e)try{(0,a.P5)(u)}catch(e){}});try{(0,i.FJ)(u)}catch(e){}let h=async()=>{{let e=(0,c.LO)(u);e.settings.minimumFetchIntervalMillis=36e5;try{await (0,c.LF)(e)}catch(e){console.error("Remote Config fetch failed",e)}return e}}}}]);