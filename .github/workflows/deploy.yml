name: Deploy SquareUp

on:
  push:
    branches:
      - squareup-dev
      - squareup-almost
      - squareup-live

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Environment Variables
        id: env_setup
        run: |
          if [[ "${{ github.ref_name }}" == "squareup-live" ]]; then
            echo "SERVICE=squareup-backend" >> $GITHUB_OUTPUT
            echo "DB_SECRET=PROD_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=production" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_name }}" == "squareup-almost" ]]; then
            echo "SERVICE=squareup-backend-staging" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=staging" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=staging" >> $GITHUB_OUTPUT
          else
            echo "SERVICE=squareup-backend-dev" >> $GITHUB_OUTPUT
            echo "DB_SECRET=DEV_DATABASE_URL" >> $GITHUB_OUTPUT
            echo "ENV_NAME=development" >> $GITHUB_OUTPUT
            echo "FIREBASE_TARGET=development" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Run Database Migrations
        working-directory: ./backend
        run: |
          # Use the same Python environment/deps as the app
          pip install alembic psycopg2-binary sqlalchemy sqlmodel pydantic-settings asyncpg
          
          # Fetch the secret dynamically based on branch
          DB_URL_VAL="${{ secrets[steps.env_setup.outputs.DB_SECRET] }}"
          
          # Execute migration
          DATABASE_URL="$DB_URL_VAL" ENVIRONMENT="${{ steps.env_setup.outputs.ENV_NAME }}" alembic upgrade head

      - name: Install Frontend Dependencies
        working-directory: ./frontend
        run: npm install

      - name: Deploy Backend to Cloud Run
        working-directory: ./backend
        run: |
          DB_URL_VAL="${{ secrets[steps.env_setup.outputs.DB_SECRET] }}"
          
          # Dynamic URLs based on environment
          if [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "production" ]]; then
            BASE_URL="https://app.joinsquareup.com"
          elif [[ "${{ steps.env_setup.outputs.ENV_NAME }}" == "staging" ]]; then
            BASE_URL="https://almost.joinsquareup.com"
          else
            BASE_URL="https://unclutr-monorep.web.app" # Default for dev branch
          fi

          gcloud run deploy ${{ steps.env_setup.outputs.SERVICE }} \
            --source . \
            --region us-central1 \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "DATABASE_URL=$DB_URL_VAL,ENVIRONMENT=${{ steps.env_setup.outputs.ENV_NAME }},BACKEND_URL=$BASE_URL,FRONTEND_URL=$BASE_URL,GOOGLE_REDIRECT_URI=$BASE_URL/api/v1/intelligence/calendar/google/callback,SHOPIFY_ENCRYPTION_KEY=${{ secrets.SHOPIFY_ENCRYPTION_KEY }},SHOPIFY_API_KEY=${{ secrets.SHOPIFY_API_KEY }},SHOPIFY_API_SECRET=${{ secrets.SHOPIFY_API_SECRET }}"

      - name: Deploy Frontend to Firebase
        run: |
          firebase experiments:enable webframeworks
          firebase deploy --only hosting:${{ steps.env_setup.outputs.FIREBASE_TARGET }} --token ${{ secrets.FIREBASE_TOKEN }}
